From 282ce00ac384cb6915f2b955db7bf9dfc29d4f00 Mon Sep 17 00:00:00 2001
From: Seal <info@seal.security>
Date: Fri, 4 Nov 2022 13:47:53 -0400
Subject: [PATCH 1/1] Seal Security Hotfix for setuptools 58.1.0

This patch fixes:
  CVE-2022-40897

For more information see:
  1. https://seal.security
  2. https://github.com/seal-community
  3. https://github.com/pypa/setuptools/tree/v58.1.0
---
 setuptools/package_index.py           | 2 +-
 setuptools/tests/test_packageindex.py | 1 -
 2 files changed, 1 insertion(+), 2 deletions(-)

diff --git a/setup.cfg b/setup.cfg
index 0bee3cf35..13c7d6d70 100644
--- a/setup.cfg
+++ b/setup.cfg
@@ -53,6 +53,7 @@ testing =
 
 	# local
 	mock
+	pytest-timeout
 	flake8-2020
 	virtualenv>=13.0.0
 	pytest-virtualenv>=1.2.7
diff --git a/setuptools/package_index.py b/setuptools/package_index.py
index d818f44ad..c998160e9 100644
--- a/setuptools/package_index.py
+++ b/setuptools/package_index.py
@@ -197,7 +197,7 @@ def unique_values(func):
     return wrapper
 
 
-REL = re.compile(r"""<([^>]*\srel\s*=\s*['"]?([^'">]+)[^>]*)>""", re.I)
+REL = re.compile(r"""<([^>]*\srel\s{0,10}=\s{0,10}['"]?([^'" >]+)[^>]*)>""", re.I)
 # this line is here to fix emacs' cruddy broken syntax highlighting
 
 
diff --git a/setuptools/tests/test_packageindex.py b/setuptools/tests/test_packageindex.py
index 8e9435efe..fc544c0be 100644
--- a/setuptools/tests/test_packageindex.py
+++ b/setuptools/tests/test_packageindex.py
@@ -308,3 +308,11 @@ class TestPyPIConfig:
         cred = cfg.creds_by_repository['https://pypi.org']
         assert cred.username == 'jaraco'
         assert cred.password == 'pity%'
+
+
+@pytest.mark.timeout(1)
+def test_REL_DoS():
+    """
+    REL should not hang on a contrived attack string.
+    """
+    setuptools.package_index.REL.search('< rel=' + ' ' * 2**12)
