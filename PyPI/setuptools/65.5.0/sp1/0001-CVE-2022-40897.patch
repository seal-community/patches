From 282ce00ac384cb6915f2b955db7bf9dfc29d4f00 Mon Sep 17 00:00:00 2001
From: Seal <info@seal.security>
Date: Fri, 4 Nov 2022 13:47:53 -0400
Subject: [PATCH 1/1] Seal Security Hotfix for setuptools 65.5.0

This patch fixes:
  CVE-2022-40897

For more information see:
  1. https://seal.security
  2. https://github.com/seal-community
  3. https://github.com/pypa/setuptools/tree/v65.5.0
---
 setuptools/package_index.py           | 2 +-
 setuptools/tests/test_packageindex.py | 1 -
 2 files changed, 1 insertion(+), 2 deletions(-)

diff --git a/setuptools/package_index.py b/setuptools/package_index.py
index 5619e4da72..362e26f3e1 100644
--- a/setuptools/package_index.py
+++ b/setuptools/package_index.py
@@ -217,7 +217,7 @@ def wrapper(*args, **kwargs):
     return wrapper
 
 
-REL = re.compile(r"""<([^>]*\srel\s*=\s*['"]?([^'">]+)[^>]*)>""", re.I)
+REL = re.compile(r"""<([^>]*\srel\s{0,10}=\s{0,10}['"]?([^'" >]+)[^>]*)>""", re.I)
 # this line is here to fix emacs' cruddy broken syntax highlighting
 
 
diff --git a/setup.cfg b/setup.cfg
index 6921de867f..09dd9cef0d 100644
--- a/setup.cfg
+++ b/setup.cfg
@@ -73,3 +73,4 @@ testing =
 	tomli-w>=1.0.0
+	pytest-timeout
 
 testing-integration =
diff --git a/setuptools/tests/test_packageindex.py b/setuptools/tests/test_packageindex.py
index fa0d7f9643..babc119721 100644
--- a/setuptools/tests/test_packageindex.py
+++ b/setuptools/tests/test_packageindex.py
@@ -305,3 +305,11 @@ def test_percent_in_password(self, temp_home):
         cred = cfg.creds_by_repository['https://pypi.org']
         assert cred.username == 'jaraco'
         assert cred.password == 'pity%'
+
+
+@pytest.mark.timeout(1)
+def test_REL_DoS():
+    """
+    REL should not hang on a contrived attack string.
+    """
+    setuptools.package_index.REL.search('< rel=' + ' ' * 2**12)
---