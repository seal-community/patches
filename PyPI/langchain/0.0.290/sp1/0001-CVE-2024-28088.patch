From 937bb133d898878cbb3bf8ace57edcc129f34f1e Mon Sep 17 00:00:00 2001
From: Seal <info@seal.security>
Date: Thu, 14 Mar 2024 16:22:07 +0200
Subject: [PATCH 1/1] Seal Security Hotfix for langchain 0.0.290

This patch fixes:
  CVE-2024-28088

For more information see:
  1. https://seal.security
  2. https://github.com/seal-community
  3. https://github.com/langchain-ai/langchain/tree/v0.0.290
---
 libs/langchain/langchain/utilities/loading.py  |  5 ++++-
 .../tests/unit_tests/utilities/test_loading.py | 18 ++++++++++++++++++
 2 files changed, 22 insertions(+), 1 deletion(-)

diff --git a/libs/langchain/langchain/utilities/loading.py b/libs/langchain/langchain/utilities/loading.py
index 60f3e3cf7..4c4ee1ee4 100644
--- a/libs/langchain/langchain/utilities/loading.py
+++ b/libs/langchain/langchain/utilities/loading.py
@@ -42,7 +42,10 @@ def try_load_from_hub(
     # when working with URLs that use forward slashes as the path separator.
     # Instead, use PurePosixPath to ensure that forward slashes are used as the
     # path separator, regardless of the operating system.
-    full_url = urljoin(URL_BASE.format(ref=ref), PurePosixPath(remote_path).__str__())
+    url_base = URL_BASE.format(ref=ref)
+    full_url = urljoin(url_base, PurePosixPath(remote_path).__str__())
+    if not full_url.startswith(url_base):
+        raise ValueError(f"Invalid hub path: {path}")
 
     r = requests.get(full_url, timeout=5)
     if r.status_code != 200:
diff --git a/libs/langchain/tests/unit_tests/utilities/test_loading.py b/libs/langchain/tests/unit_tests/utilities/test_loading.py
index f9a275fd8..d02d7755c 100644
--- a/libs/langchain/tests/unit_tests/utilities/test_loading.py
+++ b/libs/langchain/tests/unit_tests/utilities/test_loading.py
@@ -95,3 +95,21 @@ def test_failed_request(mocked_responses: responses.RequestsMock) -> None:
     with pytest.raises(ValueError, match=re.compile("Could not find file at .*")):
         try_load_from_hub(f"lc://{path}", loader, "chains", {"json"})
     loader.assert_not_called()
+
+
+def test_path_traversal1() -> None:
+    """Test that a path traversal attack is prevented."""
+    path = "lc://chains/../../../../../../../../../it.json"
+    loader = Mock()
+
+    with pytest.raises(ValueError):
+        try_load_from_hub(path, loader, "chains", {"json"})
+
+
+def test_path_traversal2() -> None:
+    """Test that a path traversal attack is prevented."""
+    path = "lc@ANYTHING/../../../../../../../../..://chains/it.json"
+    loader = Mock()
+
+    with pytest.raises(ValueError):
+        try_load_from_hub(path, loader, "chains", {"json"})
-- 
2.39.3

