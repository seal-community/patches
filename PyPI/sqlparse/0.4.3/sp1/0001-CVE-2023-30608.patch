From 46f5f4d082c2223f3d2382d7001f5bdc78a5052f Mon Sep 17 00:00:00 2001
From: Seal <info@seal.security>
Date: Mon, 19 Feb 2024 14:59:04 +0200
Subject: [PATCH 1/1] Seal Security Hotfix for sqlparse 0.4.3

This patch fixes:
  CVE-2023-30608

For more information see:
  1. https://seal.security
  2. https://github.com/seal-community
  3. https://github.com/andialbrecht/sqlparse/tree/0.4.3
---
 CHANGELOG            | 17 +++++++++++++++++
 sqlparse/keywords.py |  4 ++--
 tests/test_split.py  |  4 ++--
 3 files changed, 21 insertions(+), 4 deletions(-)

diff --git a/CHANGELOG b/CHANGELOG
index 229d9a4..e60ec42 100644
--- a/CHANGELOG
+++ b/CHANGELOG
@@ -1,3 +1,20 @@
+Release 0.4.3+sp1
+-----------------
+
+Notable Changes
+
+* IMPORTANT: This release fixes a security vulnerability in the
+  parser where a regular expression vulnerable to ReDOS (Regular
+  Expression Denial of Service) was used. See the security advisory
+  for details: https://github.com/andialbrecht/sqlparse/security/advisories/GHSA-rrm6-wvj7-cwh2
+  The vulnerability was discovered by @erik-krogh from GitHub
+  Security Lab (GHSL). Thanks for reporting!
+
+Bug Fixes
+
+* Fix regular expressions for string parsing.
+
+
 Release 0.4.3 (Sep 23, 2022)
 ----------------------------

diff --git a/sqlparse/keywords.py b/sqlparse/keywords.py
index d73e114..e5e8182 100644
--- a/sqlparse/keywords.py
+++ b/sqlparse/keywords.py
@@ -72,9 +72,9 @@ SQL_REGEX = {
         (r'(?![_A-ZÀ-Ü])-?(\d+(\.\d*)|\.\d+)(?![_A-ZÀ-Ü])',
          tokens.Number.Float),
         (r'(?![_A-ZÀ-Ü])-?\d+(?![_A-ZÀ-Ü])', tokens.Number.Integer),
-        (r"'(''|\\\\|\\'|[^'])*'", tokens.String.Single),
+        (r"'(''|\\'|[^'])*'", tokens.String.Single),
         # not a real string literal in ANSI SQL:
-        (r'"(""|\\\\|\\"|[^"])*"', tokens.String.Symbol),
+        (r'"(""|\\"|[^"])*"', tokens.String.Symbol),
         (r'(""|".*?[^\\]")', tokens.String.Symbol),
         # sqlite names can be escaped with [square brackets]. left bracket
         # cannot be preceded by word character or a right bracket --
diff --git a/tests/test_split.py b/tests/test_split.py
index a9d7576..e79750e 100644
--- a/tests/test_split.py
+++ b/tests/test_split.py
@@ -18,8 +18,8 @@ def test_split_semicolon():


 def test_split_backslash():
-    stmts = sqlparse.parse(r"select '\\'; select '\''; select '\\\'';")
-    assert len(stmts) == 3
+    stmts = sqlparse.parse("select '\'; select '\'';")
+    assert len(stmts) == 2


 @pytest.mark.parametrize('fn', ['function.sql',
--
2.39.2

