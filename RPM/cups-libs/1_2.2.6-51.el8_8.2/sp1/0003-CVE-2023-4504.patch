From d81d6341a3489225a722960f2085b029ec7d26b1 Mon Sep 17 00:00:00 2001
From: Seal <info@seal.security>
Date: Tue, 14 Nov 2023 11:06:21 +0000
Subject: [PATCH 3/3] Seal Security Hotfix for cups-libs 1:2.2.6-51.el8_8.2

This patch fixes:
  CVE-2023-4504

For more information see:
  1. https://seal.security
  2. https://github.com/seal-community
  3. https://git.almalinux.org/rpms/cups/releases/tag/imports/c8/cups-2.2.6-51.el8_8.2
---
 SOURCES/CVE-2023-4504.patch | 25 +++++++++++++++++++++++++
 SPECS/cups.spec             |  5 ++++-
 2 files changed, 29 insertions(+), 1 deletion(-)
 create mode 100644 SOURCES/CVE-2023-4504.patch

diff --git a/SOURCES/CVE-2023-4504.patch b/SOURCES/CVE-2023-4504.patch
new file mode 100644
index 0000000..2186ca4
--- /dev/null
+++ b/SOURCES/CVE-2023-4504.patch
@@ -0,0 +1,25 @@
+diff --git a/filter/interpret.c b/filter/interpret.c
+index 6fcf731b5..b8655c8c6 100644
+--- a/filter/interpret.c
++++ b/filter/interpret.c
+@@ -1116,7 +1116,19 @@ scan_ps(_cups_ps_stack_t *st,		/* I  - Stack */
+ 
+ 	    cur ++;
+ 
+-            if (*cur == 'b')
++	   /*
++	    * Return NULL if we reached NULL terminator, a lone backslash
++	    * is not a valid character in PostScript.
++	    */
++
++	    if (!*cur)
++	    {
++	      *ptr = NULL;
++
++	      return (NULL);
++	    }
++
++	    if (*cur == 'b')
+ 	      *valptr++ = '\b';
+ 	    else if (*cur == 'f')
+ 	      *valptr++ = '\f';
diff --git a/SPECS/cups.spec b/SPECS/cups.spec
index cb0d3a9..fea4110 100644
--- a/SPECS/cups.spec
+++ b/SPECS/cups.spec
@@ -158,7 +158,8 @@ Patch80: 0001-Require-authentication-for-CUPS-Get-Document.patch
 Patch81: CVE-2023-32324.patch
 # CVE-2023-34241 A vulnerability was found in CUPS. This issue occurs due to logging data of free memory to the logging service AFTER the connection has been closed, when it should have logged the data immediately before the connection closed, resulting in a use-after-free in cupsdAcceptClient() in scheduler/client.c
 Patch82: CVE-2023-34241.patch
-
+# CVE-2023-4504 Due to failure in validating the length provided by an attacker-crafted PPD PostScript document, CUPS and libppd are susceptible to a heap-based buffer overflow and possibly code execution.
+Patch83: CVE-2023-4504.patch
 
 
 Patch1000: cups-lspp.patch
@@ -455,6 +456,8 @@ Sends IPP requests to the specified URI and tests and/or displays the results.
 %patch81 -p1 -b .cve32324
 # CVE-2023-34241
 %patch82 -p1 -b .cve34241
+# CVE-2023-4504
+%patch83 -p1 -b .cve4504
 
 sed -i -e '1iMaxLogSize 0' conf/cupsd.conf.in
 
-- 
2.39.3

