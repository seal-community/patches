From e69f059c53588a8f70d3d1a89649a1811c000a09 Mon Sep 17 00:00:00 2001
From: Seal <info@seal.security>
Date: Tue, 14 Nov 2023 10:44:57 +0000
Subject: [PATCH 2/3] Seal Security Hotfix for cups-libs 1:2.2.6-51.el8_8.2

This patch fixes:
  CVE-2023-34241

For more information see:
  1. https://seal.security
  2. https://github.com/seal-community
  3. https://git.almalinux.org/rpms/cups/releases/tag/imports/c8/cups-2.2.6-51.el8_8.2
---
 SOURCES/CVE-2023-34241.patch | 50 ++++++++++++++++++++++++++++++++++++
 SPECS/cups.spec              |  5 ++++
 2 files changed, 55 insertions(+)
 create mode 100644 SOURCES/CVE-2023-34241.patch

diff --git a/SOURCES/CVE-2023-34241.patch b/SOURCES/CVE-2023-34241.patch
new file mode 100644
index 0000000..dfac0ea
--- /dev/null
+++ b/SOURCES/CVE-2023-34241.patch
@@ -0,0 +1,50 @@
+diff --up a/scheduler/client.c b/scheduler/client.c
+index 9730eeaaf..48e19b925 100644
+--- a/scheduler/client.c
++++ b/scheduler/client.c
+@@ -192,13 +192,11 @@ cupsdAcceptClient(cupsd_listener_t *lis)/* I - Listener socket */
+    /*
+     * Can't have an unresolved IP address with double-lookups enabled...
+     */
+-
+-    httpClose(con->http);
+-
+     cupsdLogClient(con, CUPSD_LOG_WARN,
+-                    "Name lookup failed - connection from %s closed!",
++                    "Name lookup failed - closing connection from %s!",
+                     httpGetHostname(con->http, NULL, 0));
+ 
++    httpClose(con->http);
+     free(con);
+     return;
+   }
+@@ -234,11 +232,11 @@ cupsdAcceptClient(cupsd_listener_t *lis)/* I - Listener socket */
+       * with double-lookups enabled...
+       */
+ 
+-      httpClose(con->http);
+-
+       cupsdLogClient(con, CUPSD_LOG_WARN,
+-                      "IP lookup failed - connection from %s closed!",
++                      "IP lookup failed - closing connection from %s!",
+                       httpGetHostname(con->http, NULL, 0));
++
++      httpClose(con->http);
+       free(con);
+       return;
+     }
+@@ -255,11 +253,11 @@ cupsdAcceptClient(cupsd_listener_t *lis)/* I - Listener socket */
+ 
+   if (!hosts_access(&wrap_req))
+   {
+-    httpClose(con->http);
+-
+     cupsdLogClient(con, CUPSD_LOG_WARN,
+                     "Connection from %s refused by /etc/hosts.allow and "
+ 		    "/etc/hosts.deny rules.", httpGetHostname(con->http, NULL, 0));
++
++    httpClose(con->http);
+     free(con);
+     return;
+   }
+
diff --git a/SPECS/cups.spec b/SPECS/cups.spec
index 1742b58..cb0d3a9 100644
--- a/SPECS/cups.spec
+++ b/SPECS/cups.spec
@@ -156,6 +156,9 @@ Patch79: cups-kerberos.patch
 Patch80: 0001-Require-authentication-for-CUPS-Get-Document.patch
 # CVE-2023-32324 A flaw was found in the Cups package. A buffer overflow vulnerability in the |format_log_line| function could allow remote attackers to cause a denial of service. Exploitation is only possible when the configuration file, cupsd.conf, has the value of loglevel set to DEBUG.
 Patch81: CVE-2023-32324.patch
+# CVE-2023-34241 A vulnerability was found in CUPS. This issue occurs due to logging data of free memory to the logging service AFTER the connection has been closed, when it should have logged the data immediately before the connection closed, resulting in a use-after-free in cupsdAcceptClient() in scheduler/client.c
+Patch82: CVE-2023-34241.patch
+
 
 
 Patch1000: cups-lspp.patch
@@ -450,6 +453,8 @@ Sends IPP requests to the specified URI and tests and/or displays the results.
 %patch80 -p1 -b .get-document-auth
 # CVE-2023-32324
 %patch81 -p1 -b .cve32324
+# CVE-2023-34241
+%patch82 -p1 -b .cve34241
 
 sed -i -e '1iMaxLogSize 0' conf/cupsd.conf.in
 
-- 
2.39.3

