From afa01f46083c851b46c26fb9b568869c4fd16818 Mon Sep 17 00:00:00 2001
From: Seal <info@seal.security>
Date: Mon, 26 Feb 2024 14:46:18 +0200
Subject: [PATCH 1/1] Seal Security Hotfix for ansi-regex 4.1.0

This patch fixes:
  CVE-2021-3807

For more information see:
  1. https://seal.security
  2. https://github.com/seal-community
  3. https://github.com/chalk/ansi-regex/tree/v4.1.0
---
 index.js | 2 +-
 test.js  | 5 +++++
 2 files changed, 6 insertions(+), 1 deletion(-)

diff --git a/index.js b/index.js
index c254480..9e37ec3 100644
--- a/index.js
+++ b/index.js
@@ -6,7 +6,7 @@ module.exports = options => {
 	}, options);
 
 	const pattern = [
-		'[\\u001B\\u009B][[\\]()#;?]*(?:(?:(?:[a-zA-Z\\d]*(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]*)*)?\\u0007)',
+		'[\\u001B\\u009B][[\\]()#;?]*(?:(?:(?:(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]+)*|[a-zA-Z\\d]+(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]*)*)?\\u0007)',
 		'(?:(?:\\d{1,4}(?:;\\d{0,4})*)?[\\dA-PR-TZcf-ntqry=><~]))'
 	].join('|');
 
diff --git a/test.js b/test.js
index f8b4519..ab209a1 100644
--- a/test.js
+++ b/test.js
@@ -58,6 +58,11 @@ test('match "change icon name and window title" in string', t => {
 	t.is('\u001B]0;sg@tota:~/git/\u0007\u001B[01;32m[sg@tota\u001B[01;37m misc-tests\u001B[01;32m]$'.match(ansiRegex())[0], '\u001B]0;sg@tota:~/git/\u0007');
 });
 
+test('CVE-2021-3807', t => {
+	const attackStr = '\u001B[' + ';'.repeat(10000 * 10000);
+	t.notRegex(attackStr, ansiRegex());
+});
+
 // Testing against extended codes (excluding codes ending in 0-9)
 for (const codeSet of Object.keys(ansiCodes)) {
 	for (const el of ansiCodes[codeSet]) {
-- 


