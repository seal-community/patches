From 5568000915b4c1ca542b21d259e65c571b15be7a Mon Sep 17 00:00:00 2001
From: Seal <info@seal.security>
Date: Wed, 6 Mar 2024 13:01:57 +0200
Subject: [PATCH 1/1] Seal Security Hotfix for y18n 4.0.0

This patch fixes:
  CVE-2020-7774

For more information see:
  1. https://seal.security
  2. https://github.com/seal-community
  3. https://github.com/yargs/y18n/tree/v4.0.0
---
 index.js          |  2 +-
 test/y18n-test.js | 16 ++++++++++++++++
 2 files changed, 17 insertions(+), 1 deletion(-)

diff --git a/index.js b/index.js
index d720681..727362a 100644
--- a/index.js
+++ b/index.js
@@ -11,7 +11,7 @@ function Y18N (opts) {
   this.fallbackToLanguage = typeof opts.fallbackToLanguage === 'boolean' ? opts.fallbackToLanguage : true
 
   // internal stuff.
-  this.cache = {}
+  this.cache = Object.create(null)
   this.writeQueue = []
 }
 
diff --git a/test/y18n-test.js b/test/y18n-test.js
index 2ef2737..9ea5cac 100644
--- a/test/y18n-test.js
+++ b/test/y18n-test.js
@@ -351,7 +351,23 @@ describe('y18n', function () {
       y18n().getLocale().should.equal('en')
     })
   })
+// See: https://github.com/yargs/y18n/issues/96,
+  // https://github.com/yargs/y18n/pull/107
+  describe('prototype pollution', () => {
+    it('does not pollute prototype, with __proto__ locale', () => {
+      const y = y18n()
+      y.setLocale('__proto__')
+      y.updateLocale({ polluted: 'ðŸ‘½' })
+      y.__('polluted').should.equal('ðŸ‘½')
+      ;(typeof polluted).should.equal('undefined')
+    })
 
+    it('does not pollute prototype, when __ is used with __proto__ locale', () => {
+      const __ = y18n({ locale: '__proto__' }).__
+      __('hello')
+      ;(typeof {}.hello).should.equal('undefined')
+    })
+  })
   after(function () {
     rimraf.sync('./test/locales/fr.json')
   })
-- 


