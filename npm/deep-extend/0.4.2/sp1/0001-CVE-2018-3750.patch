From f2fe13b30a9ca152bf3842e0a18a5c22cc4c5b5c Mon Sep 17 00:00:00 2001
From: Seal <info@seal.security>
Date: Sun, 11 Feb 2024 14:44:48 +0200
Subject: [PATCH 1/1] Seal Security Hotfix for deep-extend 0.4.2

This patch fixes:
  CVE-2018-3750

For more information see:
  1. https://seal.security
  2. https://github.com/seal-community
  3. https://github.com/unclechu/node-deep-extend/tree/v0.4.2
---
 lib/deep-extend.js | 7 +++++--
 test/index.spec.js | 7 +++++++
 2 files changed, 12 insertions(+), 2 deletions(-)

diff --git a/lib/deep-extend.js b/lib/deep-extend.js
index 08f70ed..8b5641b 100644
--- a/lib/deep-extend.js
+++ b/lib/deep-extend.js
@@ -102,8 +102,8 @@ var deepExtend = module.exports = function (/*obj_1, [obj_2], [obj_N]*/) {
 		}
 
 		Object.keys(obj).forEach(function (key) {
-			src = target[key]; // source value
-			val = obj[key]; // new value
+			src = safeGetProperty(target, key); // source value
+			val = safeGetProperty(obj, key); // new value
 
 			// recursion prevention
 			if (val === target) {
@@ -142,3 +142,6 @@ var deepExtend = module.exports = function (/*obj_1, [obj_2], [obj_N]*/) {
 
 	return target;
 }
+function safeGetProperty(object, property) {
+	return property === '__proto__' ? undefined : object[property];
+}
diff --git a/test/index.spec.js b/test/index.spec.js
index b4555a5..6e691b1 100644
--- a/test/index.spec.js
+++ b/test/index.spec.js
@@ -235,4 +235,11 @@ describe('deep-extend', function () {
 		});
 	});
 
+	// Vulnerability reported via hacker1: https://hackerone.com/reports/311333
+	it('should not modify Object prototype (hacker1 #311333)', function () {
+		var a = {};
+		extend({}, JSON.parse('{"__proto__":{"oops":"It works!"}}'))
+		should.not.exist(a.oops);
+		should.not.exist(Object.prototype.oops);
+	});
 });
-- 


