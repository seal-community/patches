From ef7e34f52939a1cefbd499109d8bca23becfb67f Mon Sep 17 00:00:00 2001
From: Seal <info@seal.security>
Date: Wed, 20 Sep 2023 14:53:33 +0300
Subject: [PATCH 2/2] Seal Security Hotfix for minimist 0.0.10

This patch fixes:
  CVE-2020-7598

For more information see:
  1. https://seal.security
  2. https://github.com/seal-community
  3. https://github.com/minimistjs/minimist/tree/v0.0.10
---
 index.js      | 13 +++++++++++--
 test/proto.js | 20 ++++++++++++++++++++
 2 files changed, 31 insertions(+), 2 deletions(-)
 create mode 100644 test/proto.js

diff --git a/index.js b/index.js
index 584f551..5349173 100644
--- a/index.js
+++ b/index.js
@@ -159,12 +159,21 @@ function hasKey (obj, keys) {
 
 function setKey (obj, keys, value) {
     var o = obj;
-    keys.slice(0,-1).forEach(function (key) {
+    for (var i = 0; i < keys.length-1; i++) {
+        var key = keys[i];
+        if (key === '__proto__') return;
         if (o[key] === undefined) o[key] = {};
+        if (o[key] === Object.prototype || o[key] === Number.prototype
+            || o[key] === String.prototype) o[key] = {};
+        if (o[key] === Array.prototype) o[key] = [];
         o = o[key];
-    });
+    }
     
     var key = keys[keys.length - 1];
+    if (key === '__proto__') return;
+    if (o === Object.prototype || o === Number.prototype
+        || o === String.prototype) o = {};
+    if (o === Array.prototype) o = [];
     if (o[key] === undefined || typeof o[key] === 'boolean') {
         o[key] = value;
     }
diff --git a/test/proto.js b/test/proto.js
new file mode 100644
index 0000000..3f68e90
--- /dev/null
+++ b/test/proto.js
@@ -0,0 +1,20 @@
+var parse = require('../');
+var test = require('tape');
+
+test('proto pollution', function (t) {
+    var argv = parse(['--__proto__.x', '123']);
+    t.equal({}.x, undefined);
+    t.equal(argv.__proto__.x, undefined);
+    t.equal(argv.x, undefined);
+    t.end();
+});
+
+
+test('proto pollution (array)', function (t) {
+    var argv = parse(['--x','4','--x','5','--x.__proto__.z','789']);
+    t.equal({}.z, undefined);
+    t.deepEqual(argv.x, [4, 5]);
+    t.equal(argv.x.z, undefined);
+    t.equal(argv.x.__proto__.z, undefined);
+    t.end();
+});
\ No newline at end of file
-- 


