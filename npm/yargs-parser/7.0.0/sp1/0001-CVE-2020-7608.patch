From abce9c6069978f220af99e47b090242462058ae6 Mon Sep 17 00:00:00 2001
From: Seal <info@seal.security>
Date: Mon, 13 Feb 2023 21:09:47 +0200
Subject: [PATCH 1/1] Seal Security Hotfix for yargs-parser 7.0.0

This patch fixes:
  CVE-2020-7608

For more information see:
  1. https://seal.security
  2. https://github.com/seal-community
  3. https://github.com/yargs/yargs-parser/tree/v7.0.0
---
 index.js                  |  8 +++++++-
 test/fixtures/config.json | 11 ++++++++++-
 test/yargs-parser.js      | 28 ++++++++++++++++++++++++++++
 3 files changed, 45 insertions(+), 2 deletions(-)

diff --git a/index.js b/index.js
index 7315406..0241601 100644
--- a/index.js
+++ b/index.js
@@ -557,11 +557,12 @@ function parse (args, opts) {
     if (!configuration['dot-notation']) keys = [keys.join('.')]
 
     keys.slice(0, -1).forEach(function (key) {
+      key = sanitizeKey(key)
       if (o[key] === undefined) o[key] = {}
       o = o[key]
     })
 
-    var key = keys[keys.length - 1]
+    var key = sanitizeKey(keys[keys.length - 1])
 
     var isTypeArray = checkAllAliases(keys.join('.'), flags.arrays)
     var isValueArray = Array.isArray(value)
@@ -761,4 +762,9 @@ Parser.detailed = function (args, opts) {
   return parse(args.slice(), opts)
 }
 
+function sanitizeKey (key) {
+  if (key === '__proto__') return '___proto___'
+  return key
+}
+
 module.exports = Parser
diff --git a/test/fixtures/config.json b/test/fixtures/config.json
index 4337646..7065ae6 100644
--- a/test/fixtures/config.json
+++ b/test/fixtures/config.json
@@ -3,5 +3,14 @@
     "z": 55,
     "foo": "baz",
     "version": "1.0.2",
-    "truthy": true
+    "truthy": true,
+    "toString": "method name",
+    "__proto__": {
+      "aaa": 99
+    },
+    "bar": {
+      "__proto__": {
+        "bbb": 100
+      }
+    }
 }
diff --git a/test/yargs-parser.js b/test/yargs-parser.js
index 373f8d3..22dc956 100644
--- a/test/yargs-parser.js
+++ b/test/yargs-parser.js
@@ -416,6 +416,26 @@ describe('yargs-parser', function () {
   describe('config', function () {
     var jsonPath = path.resolve(__dirname, './fixtures/config.json')
 
+    // Patching for https://snyk.io/vuln/SNYK-JS-YARGSPARSER-560381
+    it('should not pollute the prototype', function () {
+      const argv = parser(['--foo', 'bar'], {
+        alias: {
+          z: 'zoom'
+        },
+        default: {
+          settings: jsonPath
+        },
+        config: 'settings'
+      })
+
+      argv.should.have.property('herp', 'derp')
+      argv.should.have.property('zoom', 55)
+      argv.should.have.property('foo').and.deep.equal('bar')
+
+      expect({}.bbb).to.equal(undefined)
+      expect({}.aaa).to.equal(undefined)
+    })
+
     // See: https://github.com/chevex/yargs/issues/12
     it('should load options and values from default config if specified', function () {
       var argv = parser([ '--foo', 'bar' ], {
@@ -2430,4 +2450,12 @@ describe('yargs-parser', function () {
     })
     argv.a.should.deep.equal(['a.txt', 'b.txt'])
   })
+
+  // Patching for https://snyk.io/vuln/SNYK-JS-YARGSPARSER-560381
+  it('should not pollute the prototype', function () {
+    parser(['-f.__proto__.foo', '99', '-x.y.__proto__.bar', '100', '--__proto__', '200'])
+    Object.keys({}.__proto__).length.should.equal(0) // eslint-disable-line
+    expect({}.foo).to.equal(undefined)
+    expect({}.bar).to.equal(undefined)
+  })
 })
-- 
2.34.1

