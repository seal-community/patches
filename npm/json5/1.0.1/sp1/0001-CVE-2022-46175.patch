From 1468a1010d24ef6faed158e0335293fd811d8919 Mon Sep 17 00:00:00 2001
From: Seal <info@seal.security>
Date: Thu, 22 Feb 2024 16:10:31 +0200
Subject: [PATCH 1/1] Seal Security Hotfix for json5 1.0.1

This patch fixes:
  CVE-2022-46175

For more information see:
  1. https://seal.security
  2. https://github.com/seal-community
  3. https://github.com/json5/json5/tree/v1.0.1
---
 src/parse.js  | 41 ++++++++++++++++++++++++++++++++++-------
 test/parse.js |  5 +++++
 2 files changed, 39 insertions(+), 7 deletions(-)

diff --git a/src/parse.js b/src/parse.js
index 675d4c3..2d62b29 100644
--- a/src/parse.js
+++ b/src/parse.js
@@ -42,12 +42,34 @@ export default function parse (text, reviver) {
 function internalize (holder, name, reviver) {
     const value = holder[name]
     if (value != null && typeof value === 'object') {
-        for (const key in value) {
-            const replacement = internalize(value, key, reviver)
-            if (replacement === undefined) {
-                delete value[key]
-            } else {
-                value[key] = replacement
+        if (Array.isArray(value)) {
+            for (let i = 0; i < value.length; i++) {
+                const key = String(i)
+                const replacement = internalize(value, key, reviver)
+                if (replacement === undefined) {
+                    delete value[key]
+                } else {
+                    Object.defineProperty(value, key, {
+                        value: replacement,
+                        writable: true,
+                        enumerable: true,
+                        configurable: true,
+                    })
+                }
+            }
+        } else {
+            for (const key in value) {
+                const replacement = internalize(value, key, reviver)
+                if (replacement === undefined) {
+                    delete value[key]
+                } else {
+                    Object.defineProperty(value, key, {
+                        value: replacement,
+                        writable: true,
+                        enumerable: true,
+                        configurable: true,
+                    })
+                }
             }
         }
     }
@@ -973,7 +995,12 @@ function push () {
         if (Array.isArray(parent)) {
             parent.push(value)
         } else {
-            parent[key] = value
+            Object.defineProperty(parent, key, {
+                value,
+                writable: true,
+                enumerable: true,
+                configurable: true,
+            })
         }
     }
 
diff --git a/test/parse.js b/test/parse.js
index 9d4f4e0..7229f03 100644
--- a/test/parse.js
+++ b/test/parse.js
@@ -33,6 +33,11 @@ describe('JSON5', () => {
                 assert.deepStrictEqual(JSON5.parse('{\\u0061\\u0062:1,\\u0024\\u005F:2,\\u005F\\u0024:3}'), {ab: 1, $_: 2, _$: 3})
             })
 
+            it('preserves __proto__ property names', () => {
+                // eslint-disable-next-line no-proto
+                assert.strictEqual(JSON5.parse('{"__proto__":1}').__proto__, 1)
+            })
+
             it('parses multiple properties', () => {
                 assert.deepStrictEqual(JSON5.parse('{abc:1,def:2}'), {abc: 1, def: 2})
             })
-- 


