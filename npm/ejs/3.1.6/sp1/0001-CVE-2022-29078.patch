From 4ad185affe2e54d8b048ba529ce7c0bc1af10314 Mon Sep 17 00:00:00 2001
From: Seal <info@seal.security>
Date: Thu, 7 Mar 2024 17:24:43 +0200
Subject: [PATCH 1/1] Seal Security Hotfix for ejs 3.1.6

This patch fixes:
  CVE-2022-29078

For more information see:
  1. https://seal.security
  2. https://github.com/seal-community
  3. https://github.com/mde/ejs/tree/v3.1.6
---
 lib/ejs.js  | 10 ++++++++++
 test/ejs.js | 28 ++++++++++++++++++++++++++++
 2 files changed, 38 insertions(+)

diff --git a/lib/ejs.js b/lib/ejs.js
index aa6322e3..9ac67026 100755
--- a/lib/ejs.js
+++ b/lib/ejs.js
@@ -64,6 +64,7 @@ var _OPTS_PASSABLE_WITH_DATA = ['delimiter', 'scope', 'context', 'debug', 'compi
 // so we make an exception for `renderFile`
 var _OPTS_PASSABLE_WITH_DATA_EXPRESS = _OPTS_PASSABLE_WITH_DATA.concat('cache');
 var _BOM = /^\uFEFF/;
+var _JS_IDENTIFIER = /^[a-zA-Z_$][0-9a-zA-Z_$]*$/;
 
 /**
  * EJS template function cache. This can be a LRU object from lru-cache NPM
@@ -587,12 +588,21 @@ Template.prototype = {
         '  var __output = "";\n' +
         '  function __append(s) { if (s !== undefined && s !== null) __output += s }\n';
       if (opts.outputFunctionName) {
+        if (!_JS_IDENTIFIER.test(opts.outputFunctionName)) {
+          throw new Error('outputFunctionName is not a valid JS identifier.');
+        }
         prepended += '  var ' + opts.outputFunctionName + ' = __append;' + '\n';
       }
+      if (opts.localsName && !_JS_IDENTIFIER.test(opts.localsName)) {
+        throw new Error('localsName is not a valid JS identifier.');
+      }
       if (opts.destructuredLocals && opts.destructuredLocals.length) {
         var destructuring = '  var __locals = (' + opts.localsName + ' || {}),\n';
         for (var i = 0; i < opts.destructuredLocals.length; i++) {
           var name = opts.destructuredLocals[i];
+          if (!_JS_IDENTIFIER.test(name)) {
+            throw new Error('destructuredLocals['+i+'] is not a valid JS identifier.');
+          }
           if (i > 0) {
             destructuring += ',\n  ';
           }
diff --git a/test/ejs.js b/test/ejs.js
index 5360499d..420e1d96 100755
--- a/test/ejs.js
+++ b/test/ejs.js
@@ -1167,3 +1167,31 @@ suite('meta information', function () {
     assert.strictEqual(ejs.name, 'ejs');
   });
 });
+
+suite('identifier validation', function () {
+  test('invalid outputFunctionName', function() {
+    assert.throws(function() {
+      ejs.compile('<p>yay</p>', {outputFunctionName: 'x;console.log(1);x'});
+    }, /outputFunctionName is not a valid JS identifier/);
+  });
+
+  test('invalid localsName', function() {
+    var locals = Object.create(null);
+    void(locals);
+    assert.throws(function() {
+      ejs.compile('<p>yay</p>', {
+        localsName: 'function(){console.log(1);return locals;}()'});
+    }, /localsName is not a valid JS identifier/);
+  });
+
+  test('invalid destructuredLocals', function() {
+    var locals = {};
+    void(locals);
+    assert.throws(function() {
+      ejs.compile('<p>yay</p>', {
+        destructuredLocals: [
+          'console.log(1); //'
+        ]});
+    }, /destructuredLocals\[0\] is not a valid JS identifier/);
+  });
+});
\ No newline at end of file
-- 


